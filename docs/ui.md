# Waifuset UI 介绍

Waifuset 提供 Gradio UI 交互界面帮助管理数据集标注。

## 启动方式

### 启动参数

- `--source`：数据集根目录路径。
- `--write_to_txt`：是否将标注信息写入 txt 文件。
- `--write_to_database`：是否将标注信息写入数据库文件。
- `--database_file`：数据库文件路径。
- `--language`：界面语言。'en' 为英文，'cn' 为中文。
- `--chunk_size`：每页显示的图像数量，默认为 80，太高会导致图像渲染缓慢。
- `--share`：是否共享 Gradio 网页。
- `--port`：Gradio 网页的端口。

### 用法一：文本标注读写模式。

用法一是最简单的标注模式，每张图像的标注文件将被保存在与图像文件同名，后缀为 txt 的文件中。

这种格式的标注适用于绝大多数训练脚本，且能很容易地浏览和编辑。

```bash
python api.py --write_to_txt --language cn
```

### 用法二：数据库标注读写模式。

虽然用法一的标注存储方式更加直观，但存在以下缺陷：

- 不高效：每张图像都有一个对应的 txt 文件，在数据集较大时，数据集将包含大量文件，占用大量空间的同时还会产生大量读写操作，极大地降低数据集读写、编辑和传输的效率。
- 不灵活：由于每张图像有且仅有一个 txt 文件，且 txt 仅包含标注而没有更多数据的元信息。
- 不安全：txt 文件容易被误删、误改，且备份和还原困难。

用法二将标注信息写入数据库文件，而不是 txt 文件。

```bash
python api.py --write_to_database --database_file 'path/to/database.json' --language cn
```

其中，`path/to/database.json` 为数据库文件的输出路径。

用法二将标注信息写入 JSON 数据库文件，而不是 txt 文件。这种方式更加灵活，可以存储更多的元信息，且更加安全。

## 定义

Waifuset 对数据有自身的命名方式和习惯，参照[术语](#术语)表格以了解更多。

### 术语

| 术语                      | 定义                                                                                                         |
| ------------------------- | ------------------------------------------------------------------------------------------------------------ |
| 标注（Caption）           | 图像描述的统称。                                                                                             |
| 标签（tag）               | 标注中的一个 Tag。                                                                                           |
| 描述（Description）       | 数据的自然语言标注。                                                                                         |
| 数据类别（Category）      | 数据的类别。一个数据的类别是其图像文件所处文件夹的名称                                                       |
| 数据父类(Source)          | 一个数据所在文件夹所在的文件夹的名称。                                                                       |
| 艺术家标签（Artist Tag）  | 特殊标签的一种，标注中的艺术家标签，格式为 `artist: xxx` 或 `by xxx`。                                       |
| 角色标签（Character Tag） | 特殊标签的一种，标注中的角色标签，格式为 `character: xxx`。                                                  |
| 风格标签（Style Tag）     | 特殊标签的一种，标注中的风格标签，格式为 `style: xxx`。                                                      |
| 质量标签（Quality Tag）   | 特殊标签的一种，标注中的质量标签，格式为 `xxx quality`。                                                     |
| **数据指纹（Image Key）** | 数据的唯一辨识符，数据的身份证，具体是图像文件不带后缀的文件名。**请确保数据集中没有文件名相同的两张图像**。 |
| 数据全集                  | 数据集中的所有数据。                                                                                         |
| 数据子集                  | 数据集中的一个子集。                                                                                         |
| **当前数据子集**          | 当前处理数据的**最大范围**。Waifuset 启动时，为数据全集，可通过加载某类数据或搜索某些数据而改变。            |

### 数据属性

每个数据的属性记录其可能在训练中用到的信息。

| 属性名称 | 属性描述                                                                                                                |
| -------- | ----------------------------------------------------------------------------------------------------------------------- |
| 数据指纹 | 见[术语](#术语)                                                                                                         |
| 标注     | Tag 形式的标注，具体是按逗号分隔的若干个标签。                                                                          |
| 描述     | 见[术语](#术语)                                                                                                         |
| 艺术家   | 从标注中解析出的艺术家标签。每个数据最多有一个艺术家标签。在标注中以 `artist: xxx` 或 `by xxx` 的形式存在。             |
| 角色     | 从标注中解析出的角色标签。在标注中以 `character: xxx` 的形式存在。                                                      |
| 风格     | 从标注中解析出的风格标签。在标注中以 `style: xxx` 的形式存在。                                                          |
| 质量     | 从标注中解析出的质量标签。每个数据最多有一个质量标签。每个数据最多有一个质量标签。在标注中以 `xxx quality` 的形式存在。 |
| 美学评分 | 图像的美学评分，从 0~10。通常，分数越高，图像质量越高。                                                                 |
| 感知哈希 | 图像的感知哈希值。用于判断相似图像。                                                                                    |
| 原始尺寸 | 图像的原始分辨率，并不一定等于图像的分辨率。用于在 SDXL 训练中提供原始分辨率信息。                                      |
| 安全评分 | 图像的安全评分，即安全分级的数值化衡量形式。                                                                            |
| 安全分级 | 图像的[安全分级](#安全分级表)。                                                                                         |

### 安全分级表

| 安全分级 | 英文         | 中文 |
| -------- | ------------ | ---- |
| g        | General      | 安全 |
| s        | Sensitive    | 敏感 |
| q        | Questionable | 存疑 |
| e        | Explicit     | 暴露 |

## 功能一览

| 功能名称                     | 功能描述                                                                                                                   | 类型     | 备注                                         |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------- | -------- | -------------------------------------------- |
| 浏览类别选择                 | 从所选数据类别中加载某一个或多个类别的数据子集。空选时，加载整个数据集。                                                   | 数据浏览 |                                              |
| 数据排序                     | 按照某一优先级排序当前数据子集。                                                                                           | 数据浏览 |                                              |
| 数据搜索/按标签搜索          | 从整个数据集中按照标签搜索数据。                                                                                           | 数据搜索 |                                              |
| 数据搜索/按标签搜索/加载标签 | 读取数据集中所有标签某类标签，按标签计数排序。                                                                             | 数据搜索 |                                              |
| 数据搜索/按质量搜索          | 从整个数据集中按照质量标签搜索数据。                                                                                       | 数据搜索 |                                              |
| 数据搜索/按美学评分搜索      | 从整个数据集中按照美学评分搜索数据。                                                                                       | 数据搜索 |                                              |
| 数据搜索/按数据指纹搜索      | 从整个数据集中按照数据指纹搜索数据。                                                                                       | 数据搜索 |                                              |
| 搜索选项/子集搜索            | 勾选时，将在当前数据子集中搜索，否则在整个数据集中搜索。                                                                   | 搜索选项 |                                              |
| 搜索选项/补集搜索            | 勾选时，将搜索结果在搜索范围内取补集。                                                                                     | 搜索选项 |                                              |
| 搜索选项/正则表达式搜索      | 勾选时，将搜索标签和数据指纹解释为 Python 正则表达式。                                                                     | 搜索选项 |                                              |
| 更换数据源                   | 更换数据集的根目录路径。                                                                                                   | 数据浏览 |                                              |
| 按钮栏/随机抽样              | 从**当前数据子集**中随机抽取一个数据子集。                                                                                 | 数据浏览 | 不会改变当前数据子集                         |
| 按钮栏/撤销和重做            | 撤销或重做上一次的**数据编辑**操作。                                                                                       | 标注编辑 |                                              |
| 按钮栏/保存                  | 将所有编辑操作**实际写入**文件系统。                                                                                       | 其他     |                                              |
| 标注框/直接编辑标注          | 直接编辑标注框内的标注来修改数据的标注内容，点击标注框外任意位置保存。                                                     | 标注编辑 | 不支持批量操作                               |
| 处理选项/**批处理**          | 勾选时，对整个[当前的数据子集](#术语) 应用所施加的数据编辑操作，而非单个选中数据。                                         | 处理选项 |                                              |
| 处理选项/追加                | 勾选时，将标注编辑操作所添加的标签追加到已有标注的后面，而非前置。                                                         | 处理选项 |                                              |
| 处理选项/正则表达式          | 勾选时，在自定义标注**删除**和**替换**标签时，将所输入的标签解释为 Python 正则表达式。                                     | 处理选项 |                                              |
| 处理选项/进度条              | 勾选时，将在批处理时显示进度条。当处理范围较大时，可能会拖慢网页加载速度。                                                 | 处理选项 |                                              |
| 快速标注                     | 快速地将对应标签前置于标注中。如果标注已包含所加标签，则不修改。                                                           | 标注编辑 |                                              |
| 自定义标注                   | 向标签列表中添加自定义标签。支持[特殊标签](#特殊标签语法)和正则表达式。                                                    | 标注编辑 |                                              |
| 优化标注/**标签解析**        | 参照 Danbooru 的标签 Wiki，从标注中解析出艺术家标签和角色标签。                                                            | 标注编辑 |                                              |
| 优化标注/**标签排序**        | 依据预定义的标签优先级顺序，对标签列表进行排序。                                                                           | 标注编辑 | 配置文件：/waifuset/json/priority_table.json |
| 优化标注/标签一般去重        | 去重标注中完全相同的标签。                                                                                                 | 标注编辑 |                                              |
| 优化标注/**标签智能去重**    | 去重标注中语义重叠的标签，并保留语义信息最丰富的一者。                                                                     | 标注编辑 | 配置文件：/waifuset/json/overlap_tags.json   |
| 优化标注/**标签特征去除**    | 根据 [Hakubooru 数据库](https://github.com/KohakuBlueleaf/HakuBooru)的词频统计结果，去除标注中所有角色的核心外貌特征标签。 | 标注编辑 | 配置文件：/waifuset/json/feature_table.json  |
| 优化标注/标注格式化          | 以特定风格格式化标注。                                                                                                     | 标注编辑 |                                              |
| 工具/**标注器**              | 使用 [WaifuTaggerV3](https://huggingface.co/SmilingWolf/wd-swinv2-tagger-v3) 对图像进行标注。                              | 工具     |                                              |
| 工具/**美学评分器**          | 使用 [WaifuScorer](https://huggingface.co/Eugeoter/waifu-scorer-v2) 对图像进行美学评分。                                   | 工具     |                                              |
| 工具/自动添加美学评分标签    | 按照美学评分结果，赋予图像对应的质量标签。                                                                                 | 标注编辑 |                                              |
| 工具/哈希器                  | 计算图像的感知哈希值。                                                                                                     | 工具     |                                              |
| 缓冲区                       | 显示所有未保存的数据编辑操作。                                                                                             | 其他     |                                              |
| 数据库                       | 以数据库的方式浏览数据集。                                                                                                 | 数据浏览 |                                              |

## 数据加载

Waifuset 按照启动参数 `--source` 指定的路径加载数据集。`--source` 可指定两种数据集的路径：

1. **数据集根目录路径**：数据集根目录路径下的所有文件夹（包括文件夹的子文件夹）都会被视为数据类别，每个文件夹中的所有图像文件都会被视为数据。
   对于每个图像文件 `image.jpg`，若其同名的 txt 文件 `image.txt` 存在于同一目录下，则会读取其中的标注信息；
   若存在同名的 json 文件 `image.json` 或 `image.jpg.json` 记录其元数据（通常由 [gallery-dl](https://github.com/mikf/gallery-dl) 或 [Waifuc](https://github.com/deepghs/waifuc) 爬取 Danbooru 数据集时生成），则会读取更加丰富的标注信息，例如安全分级等。
2. **数据库文件路径**：数据库文件路径指向一个 JSON 数据库文件，该文件包含了所有数据的信息，包括图像文件路径等。

可通过更换数据源功能在使用期间切换数据全集，但请注意，更换数据源会导致所有未保存的数据编辑操作丢失，且当 `--write_to_database` 时，`--database_file` 不会改变，即保存的仍然是之前的数据库文件。

## 数据保存

出于数据安全考虑，UI 的所有数据集编辑操作都不会直接实际发生，直到您点击保存按钮。

根据您设定的启动参数，Waifuset 支持的数据集的保存方式有以下两种：

- [保存到同名 txt 文件](#用法一文本标注读写模式)（`--write_to_txt`）：将标注信息写入到与图像文件同名的 txt 文件中。该方式仅能存储图像的标注。
- [保存到数据库文件](#用法二数据库标注读写模式)（`--write_to_database`）：将标注信息写入到数据库文件中。该方式能存储更多的[数据属性](#数据属性)。
  数据库文件能够被 [Kohya-ss](https://github.com/kohya-ss/sd-scripts) 正常解析读取，以替代一般的 txt 标注文件。

两种保存方式可以同时使用，但不建议这样做。

请注意：点击保存按钮后，请耐心等待保存完成，再进行其他操作，否则会导致数据不统一或数据损坏。

### 缓冲区

为了提高数据保存效率，Waifuset 会将所有编辑操作记录到缓冲区。点击保存按钮后，缓冲区的所有操作会被一次性写入文件系统。
未在缓冲区中的操作不会被保存。
可以在缓冲区中预览所有未保存的操作。
在 Waifuset 启动时，会自动判断哪些数据需要放入缓冲区，哪些不需要。

## 数据浏览

UI 启动时，当前数据子集就是整个数据集。当前数据子集数据集显示在画廊中，单击选中单个数据后，可以对其进行处理。

可以通过选择数据类别或搜索数据，来切换当前数据子集为所有选中类别的数据子集。

### 数据搜索

数据搜索功能允许用户通过标签、质量、美学评分、数据指纹等信息快速搜索数据集中的数据。数据搜索结果会替换当前数据子集。

Waifuset 启动后的第一次进行标签搜索会比较缓慢，需等待片刻。

## 标注编辑

标注编辑是对数据的标注进行修改的各种操作。所有的标注编辑操作均以单个标签为最小操作单元。
数据标注的格式会自动规范。

请注意：务必在编辑时使用英文逗号 `,` 分隔标签，而非中文逗号 `，`！

### 标注优化算法

标注优化算法包括标签解析、标签排序、标签一般去重、标签智能去重、标签特征去除、标注格式化等功能。
大部分标注优化算法基于 [Danbooru 标签系统](https://danbooru.donmai.us/tags)。标签格式可以是下划线形式或空格形式，圆括号转义不会影响标签处理结果，暂不支持其他标签体系。

### 标注编辑示例

| 操作                                                  | 修改前                                            | 修改后                                           | 备注                                         |
| ----------------------------------------------------- | ------------------------------------------------- | ------------------------------------------------ | -------------------------------------------- |
| 添加标签 `long hair`                                  | `1girl, blonde hair, blue eyes"`                  | `long hair, 1girl, blonde hair, blue eyes`       |                                              |
| 添加标签 `long hair`                                  | `1girl, blonde hair, long hair, blue eyes"`       | `1girl, blonde hair, long hair, blue eyes`       | 由于添加前标签已存在，不会重复添加           |
| （追加地），添加标签 `long hair`                      | `1girl, blonde hair, blue eyes`                   | `1girl, blonde hair, blue eyes, long hair`       |                                              |
| 删除标签 `long hair`                                  | `1girl, blonde hair, long hair, blue eyes`        | `1girl, blonde hair, blue eyes`                  |                                              |
| （正则表达式地），删除标签 `.* hair`                  | `blonde hair, long hair, blue eyes`               | `blue eyes`                                      |                                              |
| 删除标签 `%artist%` （[特殊标签语法](#特殊标签语法)） | `artist: xxx, 1girl`                              | `1girl`                                          | %artist% 表示所有艺术家标签                  |
| 替换标签 `long hair` 为 `short hair`                  | `1girl, blonde hair, long hair, blue eyes`        | `1girl, blonde hair, short hair, blue eyes`      |                                              |
| （正则表达式地）替换标签 `(.*) hair` 为 `\1 ponytail` | `blonde hair, long hair, blue eyes`               | `blonde ponytail, long ponytail, blue eyes`      |                                              |
| （不匹配标签地）替换标签 `long hair` 为 `ponytail`    | `long hair, very long hair`                       | `ponytail, very ponytail`                        |                                              |
| 标签解析                                              | `ganyu (genshin impact), blue hair`               | `character: ganyu (genshin impact), blue hair`   | ganyu (genshin impact) 被解析成角色标签      |
| 标签排序                                              | `blue hair, 1girl, character: xxx`                | `1girl, character: xxx, blue hair`               |                                              |
| 标签一般去重                                          | `1girl, blonde hair, blue eyes, blonde hair`      | `1girl, blonde hair, blue eyes`                  |                                              |
| 标签智能去重                                          | `long hair, very long hair, absurdly long hair`   | `absurdly long hair`                             |                                              |
| 标签特征去除                                          | `honma meiko, long hair, blue eyes, lolita dress` | `honma meiko, lolita dress`                      | 长发蓝眼是角色 honma meiko（面码）的核心特征 |
| 格式化标注为解析式                                    | `honma meiko, by xxx, 3d`                         | `character: honma meiko, artist: xxx, style: 3d` |                                              |
| 格式化标注为标准式                                    | `character: honma meiko, artist: xxx, style: 3d`  | `honma meiko, by xxx, 3d`                        |                                              |
| 格式化标注为下划线                                    | `blonde hair, blue eyes`                          | `blonde_hair, blue_eyes`                         |                                              |

### 特殊标签语法

自定义标注中的删除和替换标签支持一些特殊标签语法，来在参与运算时代表或匹配一些特殊的标签。

| 标签语法      | 含义           |
| ------------- | -------------- |
| `%artist%`    | 所有艺术家标签 |
| `%character%` | 所有角色标签   |
| `%style%`     | 所有风格标签   |
| `%quality%`   | 所有质量标签   |
| `%copyright%` | 所有著作标签   |
| `%cat%`       | 匹配数据类别名 |
| `%stem%`      | 匹配数据指纹   |

### 标签排序

模型训练时，标签的顺序会影响模型的训练效果。标签排序功能按照语义、逻辑和重要性排序标签，能够提高模型的训练效果。

只有在 Danbooru 中有记录的标签才会被排序，未知标签的优先级最低。默认的标签优先级顺序遵循以下原则：

1. 从主到次，从大到小，从重要到不重要；
2. 质量和美学标签后置；
3. 艺术家、风格和角色标签前置；
4. 未知标签后置。

您可在 `/waifuset/json/priority_table.json` 中浏览和修改一般标签优先级顺序。但注意，每次项目更新都会覆盖此文件，请在更新前备份。
