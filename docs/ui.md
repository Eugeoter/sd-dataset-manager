# Waifuset UI 介绍

Waifuset 提供 Gradio UI 交互界面帮助管理数据集标注。

在 waifuset 中，每一个数据源代表的数据集是一张表格，表格的每一行代表一个数据，每一列代表一个数据属性，例如路径、标注、质量等。每个数据都有一个独一无二的指纹作为标识，通常是图像去除后缀后的文件名，例如，`image.jpg` 的指纹是 `image`。

## 启动方式

### 启动参数配置

启动参数通过直接修改 app.py 文件的 `get_config` 函数来配置。各个参数的含义和用法简述为：

| 参数名               | 描述                                         | 默认值  |
| -------------------- | -------------------------------------------- | ------- |
| `dataset_source`     | 数据集，如数据集根目录路径或数据库文件路径。 | `None`  |
| `gradio_share`       | 是否共享 Gradio 网页到公网。                 | `False` |
| `gradio_sever_port`  | Gradio 网页端口号。默认为空则自动设置。      | `None`  |
| `gradio_sever_name`  | Gradio 网页名称。                            | `None`  |
| `gradio_max_threads` | Gradio 最大工作线程数。                      | `40`    |
| `ui_language`        | 界面语言。从 `en` 和 `cn` 之中选择。         | `cn`    |
| `ui_page_size`       | 每页显示的图片数量。                         | `None`  |
| `cpu_max_workers`    | CPU 最大工作线程数。                         | `None`  |
| `verbose`            | 是否输出详细信息。                           | `False` |

### 数据集源

数据集源参数 `dataset_source` 配置了数据集的加载方式，能够灵活地加载单个或多个数据集。

| 键名             | 描述                                                                                                       | 默认值                                        |
| ---------------- | ---------------------------------------------------------------------------------------------------------- | --------------------------------------------- |
| `name_or_path`   | 数据集文件夹的路径、数据库文件路径或 HuggingFace 数据集名称（repo id）。                                   | `None`                                        |
| `column_mapping` | 一个字典类型的数据集列名映射。将字典键对应的列改名为值对应的新列名。                                       | `None`                                        |
| `remove_columns` | 一个列表类型的数据集列名。将列表中的某些列删除。                                                           | `None`                                        |
| `primary_key`    | 数据集的主键名。                                                                                           | `image_key`                                   |
| `fp_key`         | 纯图片数据集的路径列名。仅适用于 `name_or_path` 为文件夹路径时。                                           | `image_path`                                  |
| `recur`          | 是否递归地从文件夹中加载数据，即读取文件夹及其子文件夹的所有数据。仅适用于 `name_or_path` 为文件夹路径时。 | `True`                                        |
| `exts`           | 图像文件的扩展名列表。仅适用于 `name_or_path` 为文件夹路径时。                                             | `[".jpg", ".jpeg", ".png", ".webp". ".jfif"]` |
| `tbname`         | SQLite 数据库的表名。仅适用于 `name_or_path` 为数据库文件路径时。若空则默认加载第一张表。                  | `None`                                        |
| `read_attrs`     | 是否在加载数据集时从数据文件路径（即 `fp_key` 列）对应的标注文件中读取数据属性。                           | `False`                                       |
| `cache_dir`      | 数据集缓存路径。仅适用于 HuggingFace 数据集。                                                              | `None`                                        |
| `token`          | HuggingFace 数据集的 API token。                                                                           | `None`                                        |
| `split`          | 数据集划分。仅适用于 HuggingFace 数据集。                                                                  | `None`                                        |
| `max_retries`    | 数据集加载时遇到网络问题时的最大重试次数。仅适用于 HuggingFace 数据集。默认为空则会无限重试。              | `None`                                        |

为了方便，当数据源是一个字符串时，会被视为一个仅包含 `name_or_path` 键的数据集配置。

#### 快速开始

以下简单示例演示了加载一个文件夹中的所有图片，但不会读取标注文件。

```python
dataset_source = "path/to/images"
```

#### 读取数据标注

以下示例演示了加载一个文件夹中的所有图片，并读取标注文件中的标注。

```python
dataset_source = {
    "name_or_path": "path/to/images",
    "read_attrs": True
}
```

目前，Waifuset 支持读取 .txt 和 .json 形式的标注。当一个文件名为 image.jpg 的图像有一个对应的 image.txt 或 image.json 文件时，Waifuset 会读取这个文件中的标注。

- 对于 image.txt，其中的所有文本都会被视为标注。
- 对于 image.json，它会被视为一个 Danbooru 图像元数据的 JSON 文件，其中的数据属性，例如 artist，character，safe_rating 等等会被自动解析为表格中的列。获取自 [Waifuc](https://github.com/deepghs/waifuc) 的元数据文件同样能被解析。

#### 加载数据库文件

以下示例演示了加载一个数据库文件中的数据集，读取表名为 `data` 的表格，将 `prompt` 列重命名为 `caption` 列，并删除 `image_path` 列。

```python
dataset_source = {
    "name_or_path": "path/to/database.db",
    "tbname": "data",
    "column_mapping": {"prompt": "caption"},
    "remove_columns": ["image_path"]
}
```

#### 加载 HuggingFace 数据集

以下示例演示了加载一个 HuggingFace 数据集，读取其中的 `train` 划分，并设置 Huggingface 的缓存文件夹为 `/path/to/cache`。用这种方式加载需要下载整个数据集，可能会耗费较长时间。

```python
dataset_source = {
    "name_or_path": "user/dataset",
    "split": "train",
    "cache_dir": "/path/to/cache"
}
```

#### 加载多数据源和数据集合并

当加载数据源时，如果数据源有多个，则会 “合并” 所有数据源的表格为一个。合并时，**越靠前的数据集的单元格优先级越高**。优先级低的单元格将被优先级高的单元格覆盖。
每个数据集是一张表格，行为数据，列为数据属性。数据集的合并可视为多张表格的叠加覆盖，当多张表格叠加后单元格冲突时，高优先级数据集的单元格将覆盖低优先级数据集的单元格。

这种 “合并” 的特性允许您分离一个数据集的不同数据属性。您可以将数据集的元数据文件单独保存为一个数据库文件 `metadata.json` （或其他格式），再将所有图像保存到一个文件夹 `images` 中。加载数据集时，填写两个数据源，一个指向 `metadata.json`，一个指向 `images`，即可实现数据集图像和元数据的分离：

```python
dataset_source = ["path/to/images", "path/to/metadata.json"]
```

当使用多数据集源时，必须指定在 UI 内指定 `save_path` 为数据库文件路径，以保存合并后的数据集。

## 定义

Waifuset 对数据有自身的命名方式和习惯，参照[术语](#术语)表格以了解更多。

### 术语

| 术语                      | 定义                                                                                                         |
| ------------------------- | ------------------------------------------------------------------------------------------------------------ |
| 标注（Caption）           | 图像描述的统称。                                                                                             |
| 标签（Tag）               | 标注中的一个 Tag。                                                                                           |
| 描述（Description）       | 数据的自然语言标注。                                                                                         |
| 数据类别（Category）      | 数据的类别。一个数据的类别是其图像文件所处文件夹的名称                                                       |
| 数据父类(Source)          | 一个数据所在文件夹所在的文件夹的名称。                                                                       |
| 艺术家标签（Artist Tag）  | 特殊标签的一种，标注中的艺术家标签，格式为 `artist: xxx` 或 `by xxx`。                                       |
| 角色标签（Character Tag） | 特殊标签的一种，标注中的角色标签，格式为 `character: xxx`。                                                  |
| 风格标签（Style Tag）     | 特殊标签的一种，标注中的风格标签，格式为 `style: xxx`。                                                      |
| 质量标签（Quality Tag）   | 特殊标签的一种，标注中的质量标签，格式为 `xxx quality`。                                                     |
| **数据指纹（Image Key）** | 数据的唯一辨识符，数据的身份证，具体是图像文件不带后缀的文件名。**请确保数据集中没有文件名相同的两张图像**。 |
| 数据全集                  | 数据集中的所有数据。                                                                                         |
| 数据子集                  | 数据集中的一个子集。                                                                                         |
| **当前数据子集**          | 当前处理数据的**最大范围**。Waifuset 启动时，为数据全集，可通过加载某类数据或搜索某些数据而改变。            |

### 数据属性

每个数据的属性记录其可能在训练中用到的信息。

| 属性名称 | 属性描述                                                                                                                |
| -------- | ----------------------------------------------------------------------------------------------------------------------- |
| 数据指纹 | 见[术语](#术语)                                                                                                         |
| 标注     | Tag 形式的标注，具体是按逗号分隔的若干个标签。                                                                          |
| 描述     | 见[术语](#术语)                                                                                                         |
| 艺术家   | 从标注中解析出的艺术家标签。每个数据最多有一个艺术家标签。在标注中以 `artist: xxx` 或 `by xxx` 的形式存在。             |
| 角色     | 从标注中解析出的角色标签。在标注中以 `character: xxx` 的形式存在。                                                      |
| 风格     | 从标注中解析出的风格标签。在标注中以 `style: xxx` 的形式存在。                                                          |
| 质量     | 从标注中解析出的质量标签。每个数据最多有一个质量标签。每个数据最多有一个质量标签。在标注中以 `xxx quality` 的形式存在。 |
| 美学评分 | 图像的美学评分，从 0~10。通常，分数越高，图像质量越高。                                                                 |
| 感知哈希 | 图像的感知哈希值。用于判断相似图像。                                                                                    |
| 原始尺寸 | 图像的原始分辨率，并不一定等于图像的分辨率。用于在 SDXL 训练中提供原始分辨率信息。                                      |
| 安全评分 | 图像的安全评分，即安全分级的数值化衡量形式。                                                                            |
| 安全分级 | 图像的[安全分级](#安全分级表)。                                                                                         |

### 安全分级表

| 安全分级 | 英文         | 中文 |
| -------- | ------------ | ---- |
| g        | General      | 安全 |
| s        | Sensitive    | 敏感 |
| q        | Questionable | 存疑 |
| e        | Explicit     | 暴露 |

## 功能一览

| 功能名称                     | 功能描述                                                                                                                                                | 类型     | 备注                                                                                                                                        |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| 浏览类别选择                 | 从所选数据类别中加载某一个或多个类别的数据子集。空选时，加载整个数据集。                                                                                | 数据浏览 |                                                                                                                                             |
| 数据排序                     | 按照某一优先级排序当前数据子集。                                                                                                                        | 数据浏览 |                                                                                                                                             |
| 数据搜索/按标签搜索          | 从整个数据集中按照标签搜索数据。                                                                                                                        | 数据搜索 |                                                                                                                                             |
| 数据搜索/按标签搜索/加载标签 | 读取数据集中所有标签某类标签，按标签计数排序。                                                                                                          | 数据搜索 |                                                                                                                                             |
| 数据搜索/按质量搜索          | 从整个数据集中按照质量标签搜索数据。                                                                                                                    | 数据搜索 |                                                                                                                                             |
| 数据搜索/按美学评分搜索      | 从整个数据集中按照美学评分搜索数据。                                                                                                                    | 数据搜索 |                                                                                                                                             |
| 数据搜索/按数据指纹搜索      | 从整个数据集中按照数据指纹搜索数据。                                                                                                                    | 数据搜索 |                                                                                                                                             |
| 搜索选项/子集搜索            | 勾选时，将在当前数据子集中搜索，否则在整个数据集中搜索。                                                                                                | 搜索选项 |                                                                                                                                             |
| 搜索选项/补集搜索            | 勾选时，将搜索结果在搜索范围内取补集。                                                                                                                  | 搜索选项 |                                                                                                                                             |
| 搜索选项/正则表达式搜索      | 勾选时，将搜索标签和数据指纹解释为 Python 正则表达式。                                                                                                  | 搜索选项 |                                                                                                                                             |     |
| 按钮栏/撤销和重做            | 撤销或重做上一次的**数据编辑**操作。                                                                                                                    | 标注编辑 |                                                                                                                                             |
| 按钮栏/保存                  | 将所有编辑操作**实际写入**文件系统。                                                                                                                    | 其他     |                                                                                                                                             |
| 标注框/直接编辑标注          | 直接编辑标注框内的标注来修改数据的标注内容，点击标注框外任意位置保存。                                                                                  | 标注编辑 | 不支持批量操作                                                                                                                              |
| 处理选项/**批处理**          | 勾选时，对整个[当前的数据子集](#术语) 应用所施加的数据编辑操作，而非单个选中数据。                                                                      | 处理选项 |                                                                                                                                             |
| 处理选项/追加                | 勾选时，将标注编辑操作所添加的标签追加到已有标注的后面，而非前置。                                                                                      | 处理选项 |                                                                                                                                             |
| 处理选项/正则表达式          | 勾选时，在自定义标注**删除**和**替换**标签时，将所输入的标签解释为 Python 正则表达式。                                                                  | 处理选项 |                                                                                                                                             |
| 处理选项/进度条              | 勾选时，将在批处理时显示进度条。当处理范围较大时，可能会拖慢网页加载速度。                                                                              | 处理选项 |                                                                                                                                             |
| 快速标注                     | 快速地将对应标签前置于标注中。如果标注已包含所加标签，则不修改。                                                                                        | 标注编辑 |                                                                                                                                             |
| 自定义标注                   | 向标签列表中添加自定义标签。支持[特殊标签](#特殊标签语法)和正则表达式。                                                                                 | 标注编辑 |                                                                                                                                             |
| 优化标注/**标签解析**        | 参照 Danbooru 的标签 Wiki，从标注中解析出艺术家标签和角色标签。                                                                                         | 标注编辑 |                                                                                                                                             |
| 优化标注/**标签排序**        | 依据预定义的标签优先级顺序，对标签列表进行排序。                                                                                                        | 标注编辑 | 配置文件：/waifuset/json/priority_table.json                                                                                                |
| 优化标注/标签一般去重        | 去重标注中完全相同的标签。                                                                                                                              | 标注编辑 |                                                                                                                                             |
| 优化标注/**标签智能去重**    | 去重标注中语义重叠的标签，并保留语义信息最丰富的一者。                                                                                                  | 标注编辑 | 配置文件：/waifuset/json/overlap_tags.json                                                                                                  |
| 优化标注/**标签特征去除**    | 根据 [Hakubooru 数据库](https://github.com/KohakuBlueleaf/HakuBooru) 的词频统计结果，去除标注中所有角色的核心特征标签。可选择所去除核心特征标签的种类。 | 标注编辑 | 配置文件：/waifuset/json/ch2physics.json 和 /waifuset/json/ch2clothes.json                                                                  |
| 优化标注/标注格式化          | 以特定风格格式化标注。                                                                                                                                  | 标注编辑 |                                                                                                                                             |
| 工具/**标注器**              | 使用 [WaifuTaggerV3](https://huggingface.co/SmilingWolf/wd-swinv2-tagger-v3) 对图像进行标注。标注模型可切换。                                           | 工具     |                                                                                                                                             |
| 工具/**美学评分器**          | 使用 [WaifuScorerV3](https://huggingface.co/Eugeoter/waifu-scorer-v3) 对图像进行美学评分。                                                              | 工具     |                                                                                                                                             |
| 工具/自动添加美学评分标签    | 按照美学评分结果，赋予图像对应的质量标签。                                                                                                              | 标注编辑 | 配置文件：/waifui/json/quality2score.json。配置文件中的每对 “键：值” 表示键所对应质量的最低美学分数，高于该分数的数据将被赋予对应质量标签。 |
| 工具/哈希器                  | 计算图像的感知哈希值。                                                                                                                                  | 工具     |                                                                                                                                             |
| 缓冲区                       | 显示所有未保存的数据编辑操作。                                                                                                                          | 其他     |                                                                                                                                             |
| 数据库                       | 以数据库的方式浏览数据集。                                                                                                                              | 数据浏览 |                                                                                                                                             |

### 缓冲区

为了提高数据保存效率，Waifuset 会将所有编辑操作记录到缓冲区。点击保存按钮后，缓冲区的所有操作会被一次性写入文件系统。
未在缓冲区中的操作不会被保存。
可以在缓冲区中预览所有未保存的操作。
在 Waifuset 启动时，会自动判断哪些数据需要放入缓冲区，哪些不需要。

## 数据浏览

UI 启动时，当前数据子集就是整个数据集。当前数据子集数据集显示在画廊中，单击选中单个数据后，可以对其进行处理。

可以通过选择数据类别或搜索数据，来切换当前数据子集为所有选中类别的数据子集。

### 数据搜索

数据搜索功能允许用户通过标签、质量、美学评分、数据指纹等信息快速搜索数据集中的数据。数据搜索结果会替换当前数据子集。

Waifuset 启动后的第一次进行标签搜索会比较缓慢，需等待片刻。

## 标注编辑

标注编辑是对数据的标注进行修改的各种操作。所有的标注编辑操作均以单个标签为最小操作单元。
数据标注的格式会自动规范。

请注意：务必在编辑时使用英文逗号 `,` 分隔标签，而非中文逗号 `，`！

### 标注优化算法

标注优化算法包括标签解析、标签排序、标签一般去重、标签智能去重、标签特征去除、标注格式化等功能。
大部分标注优化算法基于 [Danbooru 标签系统](https://danbooru.donmai.us/tags)。标签格式可以是下划线形式或空格形式，圆括号转义不会影响标签处理结果，暂不支持其他标签体系。

### 标注编辑示例

| 操作                                                  | 修改前                                            | 修改后                                           | 备注                                         |
| ----------------------------------------------------- | ------------------------------------------------- | ------------------------------------------------ | -------------------------------------------- |
| 添加标签 `long hair`                                  | `1girl, blonde hair, blue eyes"`                  | `long hair, 1girl, blonde hair, blue eyes`       |                                              |
| 添加标签 `long hair`                                  | `1girl, blonde hair, long hair, blue eyes"`       | `1girl, blonde hair, long hair, blue eyes`       | 由于添加前标签已存在，不会重复添加           |
| （追加地），添加标签 `long hair`                      | `1girl, blonde hair, blue eyes`                   | `1girl, blonde hair, blue eyes, long hair`       |                                              |
| 删除标签 `long hair`                                  | `1girl, blonde hair, long hair, blue eyes`        | `1girl, blonde hair, blue eyes`                  |                                              |
| （正则表达式地），删除标签 `.* hair`                  | `blonde hair, long hair, blue eyes`               | `blue eyes`                                      |                                              |
| 替换标签 `long hair` 为 `short hair`                  | `1girl, blonde hair, long hair, blue eyes`        | `1girl, blonde hair, short hair, blue eyes`      |                                              |
| （正则表达式地）替换标签 `(.*) hair` 为 `\1 ponytail` | `blonde hair, long hair, blue eyes`               | `blonde ponytail, long ponytail, blue eyes`      |                                              |
| （不匹配标签地）替换标签 `long hair` 为 `ponytail`    | `long hair, very long hair`                       | `ponytail, very ponytail`                        |                                              |
| 标签解析                                              | `ganyu (genshin impact), blue hair`               | `character: ganyu (genshin impact), blue hair`   | ganyu (genshin impact) 被解析成角色标签      |
| 标签排序                                              | `blue hair, 1girl, character: xxx`                | `1girl, character: xxx, blue hair`               |                                              |
| 标签一般去重                                          | `1girl, blonde hair, blue eyes, blonde hair`      | `1girl, blonde hair, blue eyes`                  |                                              |
| 标签智能去重                                          | `long hair, very long hair, absurdly long hair`   | `absurdly long hair`                             |                                              |
| 标签特征去除                                          | `honma meiko, long hair, blue eyes, lolita dress` | `honma meiko, lolita dress`                      | 长发蓝眼是角色 honma meiko（面码）的核心特征 |
| 格式化标注为解析式                                    | `honma meiko, by xxx, 3d`                         | `character: honma meiko, artist: xxx, style: 3d` |                                              |
| 格式化标注为标准式                                    | `character: honma meiko, artist: xxx, style: 3d`  | `honma meiko, by xxx, 3d`                        |                                              |
| 格式化标注为下划线                                    | `blonde hair, blue eyes`                          | `blonde_hair, blue_eyes`                         |                                              |

### 标签排序

模型训练时，标签的顺序会影响模型的训练效果。标签排序功能按照语义、逻辑和重要性排序标签，能够提高模型的训练效果。

只有在 Danbooru 中有记录的标签才会被排序，未知标签的优先级最低。默认的标签优先级顺序遵循以下原则：

1. 从主到次，从大到小，从重要到不重要；
2. 质量和美学标签后置；
3. 艺术家、风格和角色标签前置；
4. 未知标签后置。

您可在 `waifuset/json/priority_table.json` 中浏览和修改一般标签优先级顺序。但注意，每次项目更新都会覆盖此文件，请在更新前备份。

```

```
